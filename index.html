<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Static Template</title>
  </head>
  <body>
    <div id="qr-reader" style="width: 500px;"></div>
    <div id="qr-reader-results"></div>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
      var resultContainer = document.getElementById("qr-reader-results");
      var lastResult;

      async function handleCode(code) {
        try {
          const isbnUrl = `https://openlibrary.org/isbn/${isbn}.json`;
          const response = await fetch(isbnUrl);
          const dataRaw = await response.json();
          const authors = await Promise.all(
            (dataRaw.authors || []).map(
              (author) =>
                new Promise() <
                OpenLibraryAuthor >
                ((resolve, reject) => {
                  fetch(`https://openlibrary.org${author.key}.json`)
                    .then((result) => resolve(result.json()))
                    .catch(reject);
                })
            )
          );
          const data = {
            ...dataRaw,
            authors,
            covers: (dataRaw.covers || []).map(
              (id) => `https://covers.openlibrary.org/b/id/${id}-L.jpg`
            )
          };
          const pluginMessage = {
            type: "BOOK",
            book: { source: "OPEN_LIBRARY", data }
          };
          window.parent.postMessage({ pluginMessage }, "*");
        } catch (e) {
          console.error(e);
        }
      }

      function onScanSuccess(decodedText, decodedResult) {
        if (decodedText !== lastResult) {
          lastResult = decodedText;
          if (decodedResult.result.format.formatName === "EAN_13") {
            handleCode(decodedText);
          }
        }
      }

      var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", {
        fps: 10,
        qrbox: 250
      });
      html5QrcodeScanner.render(onScanSuccess);
    </script>
  </body>
</html>
